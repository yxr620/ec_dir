# 1. 高性能纠删码数据通路v1.0

## 1.1 软件介绍

### 1.1.1 软件开发和运行的硬件环境

# give me a table of hardware configuration
|硬件环境|配置|数量|
|:---:|:---:|:---:|
|CPU|Intel(R) Xeon(R) Gold 5420+|2|
|内存|32GB|8|
|硬盘|Samsung SSD 990 PRO 2TB|2|
|硬盘|GIGABYTE AG510K2TB|2|

### 1.1.2 软件开发和运行的软件环境

|软件环境|配置|数量|
|:---:|:---:|:---:|
|操作系统|Ubuntu 22.04.3 LTS|2|
|编译器|gcc/g++ 11.4.0|8|
|构建工具|cmake version 3.22.1|

### 1.1.3 软件的编程语言

高性能纠删码数据通路v1.0使用C++和C开发，源代码使用cmake工具管理、执行。

### 1.1.4 软件程序量

3000行

# 2. 数据通路简介

## 2.1 软件框架

本节主要介绍高性能纠删码数据通路v1.0的框架和基本模块。从数据经过数据通路的角度来讲可以将高性能纠删码数据通路分为两个过程。第一个过程是将数据写入数据通路的过程。第二个过程是从数据通路读取数据的过程。

将数据写入数据通路的过程示意图如下。首先编码数据本数据放置模块预处理，被数据放置模块确定数据的放置方式。在内存中确认了数据的放置方式之后编码数据就会由高性能编码模块进行编码生成对应的校验数据块。最后全部的数据会被底层的高并发写入存储介质。

图片：编码数据->数据放置模块（水平放置、纵向放置）->高性能编解码模块（调用底层运算库：Jerasure、ISA-L）->高并发写入存储介质模块（底层SSD存储介质）

与之类似，从数据通路读取数据的过程如下。在读取过程中，待解码的数据首先从底层存储介质中被高并发读取读取存储介质模块读出。读出的数据会使用高性能编解码模块进行解码，解码之后即可得到正确的原始数据。

图片：待解码数据->高并发读取存储介质模块->高性能编解码模块（调用叠层运算库：Jerasure、ISA-L）


## 2.2 数据放置模块

数据放置模块会提供多种数据放置的方式。这些数据放置的方式具体来说可以分为三个部分，即在放置数据时的三个参数设置。

数据放置模块会首先确定将代编码的数据根据水平放置还是纵向放置。下图展示了根据数据条优先在内存中进行纵向放置的情况。纵向放置的过程和编码数据的逻辑结构相符合，每次编码的过程要跨越数据条取出对应的数据块进行编码。

pic

下图展示了块根据编码条带优先的方式水平放置方式。这种放置方式在对一组数据块编码的过程中只需要读取内存中的一段连续地址，因为整个编码条带在内存中处在相邻的地址空间中。

pic

数据放置模块接下来会设置数据块的大小。之前讨论的编码条带的大小除了由本身纠删码的格式决定，还会涉及到纠删码选择的数据块大小。不同的数据块大小决定了编码条带是否可以在编码的过程中快速的导入CPU的缓存中用于后续的计算。通常情况下数据块大小默认为4KB，而本数据放置模块为了适应不同的硬件平台和不同的纠删码格式，设置了灵活可变的数据块大小。

最后，数据放置模块会选择待编码数据在内存中放置时是否插入一定的间隔，即数据块之间的间隔。当代编码的数据纵向放置的时候数据放置模块会选择在每个数据条之间是否插入间隔。如果选择插入间隔，那么数据的放置结构如下图。数据放置模块会在每个数据条中插入大小为S'的间隔。

pic

如果代编码数据选择水平放置，数据放置模块则会选择在编码条带中是否插入间隔。如果数据放置模块选择插入了间隔，那代编码数据在内存中的结构如下图。

pic

## 2.3 高性能编解码模块

高性能编解码模块主要利用了高性能CPU的高并发能力，以及AVX扩展指令集对编解码的过程进行了充分的并行化。该模块并行任务分配过程如下。高性能编码模块将不同的编码条带分配给不同的线程，这种分配方式可以让一个线程读取一个编码条带放置的内存空间，并且在写回编码后的数据过程中也只需要访问该条带占用的内存空间。此外为了能够让并行任务分配的更平均，在程序设计的过程中使用了动态的任务分配方式。这种动态的任务分配方式可以让先完成任务的线程继续处理后续未完成的计算。相比静态分配，这种方式可以更充分的利用线程的资源，防止出现资源的浪费。

pic

对于高性能解码的模块，大部分的计算内容和编码过程相同。任务分配的过程和后续分配的策略完全相同，因此不需要进一步的说明。

## 2.4 高并发写入/读取存储介质模块

高并发写入/读取存储介质模块需要将内存和存储介质上的数据进行高效的传输。在写入数据通道的过程中高并发写入存储介质模块会将编码数据并行写入底层SSD存储介质。在写入的过程中该模块会根据数据条分配任务。在写入过程中会将不同的数据条分给独立的线程，进行并行的写入。高并发写入的过程如下：

对于高并发读取存储介质的过程和写入过程类似，同样是以数据条为单位进行并行读取。


# 3. 测试与执行

程序的测试过程一共分为三个部分，即内存中的数据编解码测试、写入存储介质模块测试、整体数据通路测试。实验均使用1.1节的环境进行。

在测试开始之前需要根据配置文件进行编译。由于管理软件为cmake，因此使用：cmake --build build指令以及cmake -B build指令生成全部的执行程序在目录build下面。

## 3.1 测试编码性能

用户使用multi_thread程序来测试数据通道中高性能编解码模块的性能。在测试过程中测试程序会使用数据放置模块放置生成数据，并且测试编码性能和解码性能。在编解码完成之后会检验数据的正确性并且输出编解码的时间和吞吐率。结果如下：


## 3.2 测试写入存储介质模块
用户使用channel_test程序来测试写入/读取存储介质模块在写入和读取底层介质时的吞吐率。在测试过程中程序同样会随机生成数据，然后调用对应模块并行写入底层介质。在写入完成之后程序会重新并行读出数据。最后程序会检测读取的数据是否正确，并且输出写入过程和读取过程的吞吐率。结果如下：



## 3.3 测试整体数据通路性能

最后使用para_ssd_read程序来测试整个数据通路的写入和读取性能。在测试过程中程序同样使用数据放置模块的规则生随机数据并且放置。之后程序测试编码和写入组成数据通路的吞吐率。完成写入通路之后对数据加入随机错误，并且测试读取和解码过程的吞吐率。完成数据通路的测试之后测试程序会进行数据正确性检验并且判断是否通过正确性检验。所有的测试结果和检验结果都会被测试程序输出。运行测试程序的结果如下：


# 4. 核心代码

# 5. 实现详情
高性能纠删码数据通路v1.0是一种针对大规模存储系统的高性能纠删码实现。该软件使用C++和C语言开发,在Ubuntu系统下进行编译和测试。

数据通路分为编码和解码两个过程。在编码过程中,数据放置模块实现多种放置策略,高性能编解码模块利用CPU并行特性实现高速编码,存储介质写入模块并行将编码数据写入SSD。在解码过程中,存储介质读取模块并行读取数据,经高性能编解码模块解码后输出原始数据。

测试验证了编解码模块、存储介质读写模块以及整体数据通路的性能。编解码模块实现了高吞吐率;存储介质读写模块也实现了高速读写;数据通路整体吞吐率较高。代码组织合理,测试完备,实现了高速稳定的纠删码数据通路。

总体而言,本软件针对大规模存储优化设计了一个高性能的纠删码数据通路,具有较高的编解码吞吐率、存储读写速度和整体数据通路性能。主要代码在scr文件夹,测试代码在test文件夹。详细设计见代码注释。





